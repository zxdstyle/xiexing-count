!function(){var ruleType={phone:function(num){return/^((\+?0?86\-?)?)1\d{10}$/.test(num)}},methodText="",archivesInfo="",makeForm=function(){var commonForm={el:null,timer:3,timeId:null,formType:"",methodText:"",isClick:!0,rules:{name:[{required:!0,message:"*请填写称呼"}],phone:[{required:!0,message:"*请填写您的电话"},{type:"phone",message:"*请填写正确的电话"}],address:[{required:!0,message:"*请填写地址"}]},getForm:function(){return this.el||(this.el=$("."+this.formClass)),this.el},validateField:function(name){var $form=this.getForm(),itemRules=this.rules[name],$el=$form.find("[name="+name+"]"),errorEl=$el.parent().find(".form-input-error"),successEl=$el.parent().find(".from-input-success"),inputSuccess;if(errorEl.text(""),$el.length)for(var val=$el.val(),j=0;j<itemRules.length;j++){var rule=itemRules[j];if(rule.required&&(!rule.type||"string"===rule.type)){if(!val)return errorEl.text(rule.message),!1;"phone"!=name&&successEl.show()}var validate=ruleType[rule.type],result;if(validate?(result=validate(val),inputSuccess=!0):(result=!0,inputSuccess=!1),!result)return errorEl.text(rule.message),successEl.hide(),!1;inputSuccess&&result&&successEl.show()}return!0},validateForm:function(){var rules=this.rules,keys=Object.keys(rules);if(!keys.length)return!1;for(var i=0;i<keys.length;i++){var valid;if(!this.validateField(keys[i]))return!1}return!0},prepareData:function(extra){return Object.assign(extra,{url:GuiJi.currentUrl,old_url:GuiJi.entranceWebUrl?GuiJi.entranceWebUrl:-1!=GuiJi.entranceUrl.indexOf(location.origin)?GuiJi.entranceUrl:GuiJi.currentUrl,enter_url:GuiJi.entranceUrl,sourceChange:GuiJi.queryData,source:GuiJi.entranceUrlSource})},postForm:function(data,callback){$.ajax({type:"POST",url:"/site/form-input",data:data,success:callback})},postFormZice:function(data,callback){$.ajax({type:"POST",url:"/score/store",data:data,success:callback})},getImgCode:function(){var form=this.getForm();$.post("/site/img-code",{_token:document.getElementsByTagName("meta")["csrf-token"].getAttribute("content")},(function(res){form.find(".img-code").show(),form.find(".img-code").find(".code-i").html(res)})),commonForm.isClick=!0},onSuccess:function(){var form=this.getForm();this.resetForm(),form.find(".j-form").hide(),form.find(".form-success").show(),form.find(".img-code").hide()},bindFieldEvent:function(name){var form,field;this.getForm().find("[name="+name+"]").on("blur",(function(){commonForm.validateField(name)}))},bindSubmitBtn:function(){var form,submit;this.getForm().find(".j-submit").on("click",(function(){commonForm.submit()}))},bindCloseBtn:function(){var onClose=function(){commonForm.resetForm(),commonForm.hideForm()},onSuccessClose=function(){commonForm.hideForm(),commonForm.resetTimer()},form=this.getForm();form.find(".j-form .form-close").on("click",onClose),$(".mask").on("click",onClose),form.find(".j-form-success .form-close").on("click",onSuccessClose)},submit:function(one,two,three){var valid=this.validateForm(),form=this.getForm();if(valid){if(!commonForm.isClick)return!1;if(commonForm.isClick=!1,"zice"===this.formType){var data=this.prepareData({key:this.key,answer:"submit",name:form.find("[name=name]").val(),phone:form.find("[name=phone]").val(),img_code:form.find("[name=code]").val()||"",step:"submit",_token:document.getElementsByTagName("meta")["csrf-token"].getAttribute("content")});this.postFormZice(data,(function(res){1==res.img_code?commonForm.getImgCode():(commonForm.onSuccess(),commonForm.startTimer((function(){location.href="/"})))}))}else{var data=commonForm.prepareData({name:form.find("[name=name]").val(),phone:form.find("[name=phone]").val(),img_code:form.find("[name=code]").val()||"",info:commonForm.getInfo&&commonForm.getInfo()||"",submit_time:(new Date).getTime(),method:this.methodText,one_source_id:one||9,two_source_id:two||17,three_source_id:three||103});commonForm.postForm({data:data,_token:document.getElementsByTagName("meta")["csrf-token"].getAttribute("content")},(function(res){if(1==res.img_code)commonForm.getImgCode();else if(commonForm.onSuccess(),"inline"!==commonForm.formType&&commonForm.startTimer(),"books"===commonForm.formType){var obj={dayIdent:JSON.parse(GuiJi.tempId).dayIdent,num:JSON.parse(GuiJi.tempId).num-1,time:864e5,date:JSON.parse(GuiJi.tempId).date};GuiJi.tempId=JSON.stringify(obj),localStorage.setItem("__guiji__",JSON.stringify(GuiJi)),$(".num-box .num").text(JSON.parse(GuiJi.tempId).num)}}))}}},resetForm:function(){var form=this.getForm();form.find("[name=name]").val(""),form.find("[name=phone]").val(""),form.find("[name=address]").val(""),form.find("[name=code]").val(""),form.find(".form-input-error").text("")},hideForm:function(){var form=this.getForm();form.find(".img-code").hide(),form.find(".j-form-success").hide(),$(".mask").hide(),form.hide()},resetTimer:function(){clearInterval(this.timeId),this.getForm().find(".j-form-success .timer").text("0"+this.timer+"s")},startTimer:function(cb){var timer=this.timer,form=this.getForm();commonForm.timeId=setInterval((function(){0===(timer-=1)?(commonForm.hideForm(),commonForm.resetTimer(),cb&&cb()):form.find(".j-form-success .timer").text("0"+timer+"s")}),1e3)},showForm:function(){var form=this.getForm();$(".mask").show(),form.find(".j-form").show(),form.show(),"books"==this.formType&&form.find(".form-address").html('\n                        <div class="form-list clearfix">\n                            <p class="form-list-bd fl">\n                                <input type="tel" autocomplete="off" name="address" class="address" placeholder="您的收货地址"/><strong class="form-input-error"></strong>\n                            </p>\n                        </div>\n                    ')},bindShowBtn:function(btn){$(btn).on("click",(function(){commonForm.showForm()}))},init:function(opt){opt=opt||{},this.formType=opt.type||"",this.methodText=opt.methodText,this.formClass=opt.formClass||"j-common-form",opt.showBtn&&this.bindShowBtn(opt.showBtn)},start:function(){this.bindFieldEvent("name"),this.bindFieldEvent("phone"),this.bindFieldEvent("address"),this.bindSubmitBtn(),"inline"!==this.formType&&(this.bindCloseBtn(),this.resetTimer())}};return commonForm},commonForm=makeForm();window.commonForm=commonForm,window.makeForm=makeForm}();